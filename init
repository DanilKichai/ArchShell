#!/bin/bash

set -e

export PATH=/usr/sbin:/usr/bin:/sbin:/bin

mountpoint -q /dev || \
  mount -t devtmpfs devtmpfs /dev
mountpoint -q /proc || \
  mount -t proc proc /proc
mountpoint -q /sys || \
  mount -t sysfs sysfs /sys
mountpoint -q /sys/firmware/efi/efivars || \
  mount -t efivarfs efivarfs /sys/firmware/efi/efivars

echo "Kexec Loader v0.4.0 (20230901)"
echo ""
echo "  █████████████████████████████████████"
echo "  █████████████████████████████████████"
echo "  ████ ▄▄▄▄▄ █▄▄▄ ▀ ▄█▀█ ▀▀█ ▄▄▄▄▄ ████"
echo "  ████ █   █ ██▄▀ █ █▄ ▀█▀ █ █   █ ████"
echo "  ████ █▄▄▄█ ██▀▄ ▄█ █▄▀▄▄▀█ █▄▄▄█ ████"
echo "  ████▄▄▄▄▄▄▄█ ▀▄█ ▀▄▀ █ ▀ █▄▄▄▄▄▄▄████"
echo "  ████  ▀  ▀▄▀█▄▀█▄█▄▀▄▀▀ █▀▄▀▀█▀▀▄████"
echo "  ████▀▀█▀█▀▄▀▀▄██▄▄▄▄█▀▄█ ▀▀ ▄▀▄█▀████"
echo "  ████▀ ▀▄█ ▄ ▄▄ █▀▄ ▀ ▀▀ ▄█  ▀▀▀▀ ████"
echo "  ████ █▄▀▀█▄█▀▄▄█▀▀   █▄ ▄▄▄▀ █ █ ████"
echo "  ████▀█▄██ ▄▀▄▄█ ▄██ █▀▀ ▄▄██▀▄▀▀█████"
echo "  ████  ▄▄▄█▄▄ ▀▀▀▄ ▄ ▄█▄ ██▀█▄ ▀█▄████"
echo "  ████▄▄▄▄▄█▄█▀▀▀▄▀ █ ▄ ▀█ ▄▄▄  ▄▄█████"
echo "  ████ ▄▄▄▄▄ ███▀ ▀ █ ▄    █▄█ ▄█▀█████"
echo "  ████ █   █ █ ▄▄▄▄ ▀▀▄█▀▄▄ ▄▄▄▄██ ████"
echo "  ████ █▄▄▄█ █▀▄█ ▄▄█▄▀█▄█▄▄▀ ▄▀ ▄ ████"
echo "  ████▄▄▄▄▄▄▄█▄▄████▄████▄▄█▄█▄████████"
echo "  █████████████████████████████████████"
echo "  █████████████████████████████████████"
echo ""
echo "https://github.com/DanilKichai/kloader"
echo ""

if [ ! -e /source ]; then
  sed -nre 's/(^|.*[ ])(source=)([^ ]*).*/\3/p' /proc/cmdline | \
    base64 -d 2>/dev/null | \
      gzip -d 1>/source 2>/dev/null || \
        exec setsid sh -c 'exec bash </dev/tty1 1>/dev/tty1 2>&1'
fi

source /source
